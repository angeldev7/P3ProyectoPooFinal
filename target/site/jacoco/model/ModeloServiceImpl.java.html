<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModeloServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">P3ProyectoPooFinal</a> &gt; <a href="index.source.html" class="el_package">model</a> &gt; <span class="el_source">ModeloServiceImpl.java</span></div><h1>ModeloServiceImpl.java</h1><pre class="source lang-java linenums">package model;

import memento.ModeloMemento;
import singleton.GestorDisponibilidad;
import org.bson.Document;
import java.util.List;
import java.util.ArrayList;
import java.util.Date;

/**
 * Implementación concreta del servicio del modelo.
 * Encapsula toda la lógica de negocio y operaciones con MongoDB.
 * 
 * @author asdw
 * @version 1.0
 */
public class ModeloServiceImpl implements IModeloService {
    
    private final MongoCRUD mongoCRUD;
    private final GestorDisponibilidad gestorDisponibilidad;
    
    /**
     * Constructor que inyecta las dependencias necesarias.
     */
<span class="nc" id="L25">    public ModeloServiceImpl() {</span>
<span class="nc" id="L26">        ConexionBD conexion = new ConexionBD();</span>
<span class="nc" id="L27">        this.mongoCRUD = new MongoCRUD(conexion);</span>
<span class="nc" id="L28">        this.gestorDisponibilidad = GestorDisponibilidad.getInstance();</span>
<span class="nc" id="L29">    }</span>
    
    // === OPERACIONES DE CLIENTES ===
    
    @Override
    public boolean registrarCliente(Cliente cliente) {
<span class="nc bnc" id="L35" title="All 6 branches missed.">        if (cliente == null || cliente.getCedula() == null || cliente.getCedula().trim().isEmpty()) {</span>
<span class="nc" id="L36">            return false;</span>
        }
        
        // Verificar que no exista ya la cédula o teléfono
<span class="nc bnc" id="L40" title="All 4 branches missed.">        if (existeCedula(cliente.getCedula()) || existeTelefono(cliente.getTelefono())) {</span>
<span class="nc" id="L41">            return false;</span>
        }
        
        try {
            // Generar ID si no existe
<span class="nc bnc" id="L46" title="All 4 branches missed.">            if (cliente.getId() == null || cliente.getId().trim().isEmpty()) {</span>
<span class="nc" id="L47">                cliente.setId(generarCodigoCliente());</span>
            }
            
<span class="nc" id="L50">            mongoCRUD.insertar(&quot;clientes&quot;, cliente.toDocument());</span>
<span class="nc" id="L51">            return true;</span>
<span class="nc" id="L52">        } catch (Exception e) {</span>
<span class="nc" id="L53">            System.err.println(&quot;Error al registrar cliente: &quot; + e.getMessage());</span>
<span class="nc" id="L54">            return false;</span>
        }
    }
    
    @Override
    public boolean eliminarCliente(String idCliente) {
<span class="nc bnc" id="L60" title="All 4 branches missed.">        if (idCliente == null || idCliente.trim().isEmpty()) {</span>
<span class="nc" id="L61">            return false;</span>
        }
        
        try {
<span class="nc" id="L65">            return mongoCRUD.eliminarPorIdConResultado(&quot;clientes&quot;, idCliente);</span>
<span class="nc" id="L66">        } catch (Exception e) {</span>
<span class="nc" id="L67">            System.err.println(&quot;Error al eliminar cliente: &quot; + e.getMessage());</span>
<span class="nc" id="L68">            return false;</span>
        }
    }
    
    @Override
    public Cliente buscarClientePorCedula(String cedula) {
<span class="nc bnc" id="L74" title="All 4 branches missed.">        if (cedula == null || cedula.trim().isEmpty()) {</span>
<span class="nc" id="L75">            return null;</span>
        }
        
        try {
<span class="nc" id="L79">            Document filtro = new Document(&quot;cedula&quot;, cedula);</span>
<span class="nc" id="L80">            List&lt;Document&gt; documentos = mongoCRUD.buscarPorFiltro(&quot;clientes&quot;, filtro);</span>
            
<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (!documentos.isEmpty()) {</span>
<span class="nc" id="L83">                return Cliente.fromDocument(documentos.get(0));</span>
            }
<span class="nc" id="L85">        } catch (Exception e) {</span>
<span class="nc" id="L86">            System.err.println(&quot;Error al buscar cliente por cédula: &quot; + e.getMessage());</span>
        }
<span class="nc" id="L88">        return null;</span>
    }
    
    @Override
    public List&lt;Cliente&gt; obtenerTodosClientes() {
        try {
<span class="nc" id="L94">            List&lt;Document&gt; documentos = mongoCRUD.listarTodos(&quot;clientes&quot;);</span>
<span class="nc" id="L95">            List&lt;Cliente&gt; clientes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            for (Document doc : documentos) {</span>
<span class="nc" id="L97">                clientes.add(Cliente.fromDocument(doc));</span>
            }
<span class="nc" id="L99">            return clientes;</span>
<span class="nc" id="L100">        } catch (Exception e) {</span>
<span class="nc" id="L101">            System.err.println(&quot;Error al obtener todos los clientes: &quot; + e.getMessage());</span>
<span class="nc" id="L102">            return new ArrayList&lt;&gt;();</span>
        }
    }

    @Override
    public Cliente buscarClientePorId(String id) {
<span class="nc bnc" id="L108" title="All 4 branches missed.">        if (id == null || id.trim().isEmpty()) return null;</span>
        try {
<span class="nc" id="L110">            Document doc = mongoCRUD.buscarPorId(&quot;clientes&quot;, id);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            return doc != null ? Cliente.fromDocument(doc) : null;</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
<span class="nc" id="L113">            System.err.println(&quot;Error al buscar cliente por ID: &quot; + e.getMessage());</span>
<span class="nc" id="L114">            return null;</span>
        }
    }

    @Override
    public boolean actualizarCliente(Cliente cliente) {
<span class="nc bnc" id="L120" title="All 4 branches missed.">        if (cliente == null || cliente.getId() == null) return false;</span>
        try {
<span class="nc" id="L122">            Document update = new Document(&quot;$set&quot;, new Document(&quot;nombre&quot;, cliente.getNombre())</span>
<span class="nc" id="L123">                .append(&quot;apellido&quot;, cliente.getApellido())</span>
<span class="nc" id="L124">                .append(&quot;cedula&quot;, cliente.getCedula())</span>
<span class="nc" id="L125">                .append(&quot;telefono&quot;, cliente.getTelefono()));</span>
<span class="nc" id="L126">            return mongoCRUD.actualizarPorId(&quot;clientes&quot;, cliente.getId(), update);</span>
<span class="nc" id="L127">        } catch (Exception e) {</span>
<span class="nc" id="L128">            System.err.println(&quot;Error al actualizar cliente: &quot; + e.getMessage());</span>
<span class="nc" id="L129">            return false;</span>
        }
    }
    
    @Override
    public boolean existeCedula(String cedula) {
<span class="nc bnc" id="L135" title="All 2 branches missed.">        return buscarClientePorCedula(cedula) != null;</span>
    }
    
    @Override
    public boolean existeTelefono(String telefono) {
<span class="nc bnc" id="L140" title="All 4 branches missed.">        if (telefono == null || telefono.trim().isEmpty()) {</span>
<span class="nc" id="L141">            return false;</span>
        }
        
        try {
<span class="nc" id="L145">            Document filtro = new Document(&quot;telefono&quot;, telefono);</span>
<span class="nc" id="L146">            List&lt;Document&gt; documentos = mongoCRUD.buscarPorFiltro(&quot;clientes&quot;, filtro);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            return !documentos.isEmpty();</span>
<span class="nc" id="L148">        } catch (Exception e) {</span>
<span class="nc" id="L149">            System.err.println(&quot;Error al verificar teléfono: &quot; + e.getMessage());</span>
<span class="nc" id="L150">            return false;</span>
        }
    }

    // === GENERACIÓN DE CÓDIGOS LEGIBLES ===
    /** Genera código incremental CLI-0001, CLI-0002 ... basándose en los IDs existentes. */
    private String generarCodigoCliente(){
        try {
<span class="nc" id="L158">            List&lt;Document&gt; docs = mongoCRUD.listarTodos(&quot;clientes&quot;);</span>
<span class="nc" id="L159">            int max = 0;</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            for (Document d: docs){</span>
<span class="nc" id="L161">                String id = d.getString(&quot;_id&quot;);</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">                if (id != null &amp;&amp; id.startsWith(&quot;CLI-&quot;)){</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                    try {int n = Integer.parseInt(id.substring(4)); if (n&gt;max) max=n;} catch(Exception ignore){}</span>
                }
            }
<span class="nc" id="L166">            return String.format(&quot;CLI-%04d&quot;, max+1);</span>
<span class="nc" id="L167">        } catch (Exception e){</span>
<span class="nc" id="L168">            return &quot;CLI-&quot;+java.util.UUID.randomUUID().toString().substring(0,8).toUpperCase();</span>
        }
    }

    /** Genera código incremental RES-0001, RES-0002 ... */
    private String generarCodigoReserva(){
        try {
<span class="nc" id="L175">            List&lt;Document&gt; docs = mongoCRUD.listarTodos(&quot;reservas&quot;);</span>
<span class="nc" id="L176">            int max = 0;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            for (Document d: docs){</span>
<span class="nc" id="L178">                String id = d.getString(&quot;_id&quot;);</span>
<span class="nc bnc" id="L179" title="All 4 branches missed.">                if (id != null &amp;&amp; id.startsWith(&quot;RES-&quot;)){</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                    try {int n = Integer.parseInt(id.substring(4)); if (n&gt;max) max=n;} catch(Exception ignore){}</span>
                }
            }
<span class="nc" id="L183">            return String.format(&quot;RES-%04d&quot;, max+1);</span>
<span class="nc" id="L184">        } catch (Exception e){</span>
<span class="nc" id="L185">            return &quot;RES-&quot;+java.util.UUID.randomUUID().toString().substring(0,8).toUpperCase();</span>
        }
    }
    
    // === OPERACIONES DE HABITACIONES ===
    
    @Override
    public List&lt;Habitacion&gt; obtenerHabitacionesDisponibles() {
        try {
<span class="nc" id="L194">            List&lt;Document&gt; documentos = mongoCRUD.listarTodos(&quot;habitaciones&quot;);</span>
<span class="nc" id="L195">            List&lt;Habitacion&gt; disponibles = new ArrayList&lt;&gt;();</span>
            
<span class="nc bnc" id="L197" title="All 2 branches missed.">            for (Document doc : documentos) {</span>
<span class="nc" id="L198">                Habitacion hab = Habitacion.fromDocument(doc);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (!hab.isOcupada()) {</span>
<span class="nc" id="L200">                    disponibles.add(hab);</span>
                }
            }
<span class="nc" id="L203">            return disponibles;</span>
<span class="nc" id="L204">        } catch (Exception e) {</span>
<span class="nc" id="L205">            System.err.println(&quot;Error al obtener habitaciones disponibles: &quot; + e.getMessage());</span>
<span class="nc" id="L206">            return new ArrayList&lt;&gt;();</span>
        }
    }
    
    @Override
    public List&lt;Habitacion&gt; obtenerHabitacionesOcupadas() {
        try {
<span class="nc" id="L213">            List&lt;Document&gt; documentos = mongoCRUD.listarTodos(&quot;habitaciones&quot;);</span>
<span class="nc" id="L214">            List&lt;Habitacion&gt; ocupadas = new ArrayList&lt;&gt;();</span>
            
<span class="nc bnc" id="L216" title="All 2 branches missed.">            for (Document doc : documentos) {</span>
<span class="nc" id="L217">                Habitacion hab = Habitacion.fromDocument(doc);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                if (hab.isOcupada()) {</span>
<span class="nc" id="L219">                    ocupadas.add(hab);</span>
                }
            }
<span class="nc" id="L222">            return ocupadas;</span>
<span class="nc" id="L223">        } catch (Exception e) {</span>
<span class="nc" id="L224">            System.err.println(&quot;Error al obtener habitaciones ocupadas: &quot; + e.getMessage());</span>
<span class="nc" id="L225">            return new ArrayList&lt;&gt;();</span>
        }
    }
    
    @Override
    public List&lt;HabitacionOcupadaInfo&gt; obtenerHabitacionesOcupadasConCliente() {
<span class="nc" id="L231">        List&lt;HabitacionOcupadaInfo&gt; resultado = new ArrayList&lt;&gt;();</span>
        
        try {
            // Obtener habitaciones ocupadas
<span class="nc" id="L235">            List&lt;Habitacion&gt; habitacionesOcupadas = obtenerHabitacionesOcupadas();</span>
            
            // Obtener todas las reservas activas
<span class="nc" id="L238">            List&lt;Reserva&gt; reservas = obtenerTodasReservas();</span>
            
<span class="nc bnc" id="L240" title="All 2 branches missed.">            for (Habitacion habitacion : habitacionesOcupadas) {</span>
                // Buscar la reserva activa para esta habitación
<span class="nc bnc" id="L242" title="All 2 branches missed.">                for (Reserva reserva : reservas) {</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">                    if (habitacion.getId().equals(reserva.getIdHabitacion()) &amp;&amp; reserva.getFechaSalida() == null) {</span>
                        // Buscar el cliente de esta reserva por ID
<span class="nc" id="L245">                        Cliente cliente = buscarClientePorId(reserva.getIdCliente());</span>
                        
<span class="nc bnc" id="L247" title="All 2 branches missed.">                        if (cliente != null) {</span>
<span class="nc" id="L248">                            HabitacionOcupadaInfo info = new HabitacionOcupadaInfo(</span>
<span class="nc" id="L249">                                habitacion.getNumero(),</span>
<span class="nc" id="L250">                                habitacion.getTipo(),</span>
<span class="nc" id="L251">                                habitacion.getPrecio(),</span>
<span class="nc" id="L252">                                cliente.getNombre(),</span>
<span class="nc" id="L253">                                cliente.getApellido(),</span>
<span class="nc" id="L254">                                cliente.getCedula(),</span>
<span class="nc" id="L255">                                reserva.getId()</span>
                            );
<span class="nc" id="L257">                            resultado.add(info);</span>
                        }
<span class="nc" id="L259">                        break; // Ya encontramos la reserva para esta habitación</span>
                    }
                }
            }
            
<span class="nc" id="L264">        } catch (Exception e) {</span>
<span class="nc" id="L265">            System.err.println(&quot;Error al obtener habitaciones ocupadas con cliente: &quot; + e.getMessage());</span>
        }
        
<span class="nc" id="L268">        return resultado;</span>
    }
    
    @Override
    public List&lt;Habitacion&gt; obtenerTodasHabitaciones() {
        try {
<span class="nc" id="L274">            List&lt;Document&gt; documentos = mongoCRUD.listarTodos(&quot;habitaciones&quot;);</span>
<span class="nc" id="L275">            List&lt;Habitacion&gt; habitaciones = new ArrayList&lt;&gt;();</span>
            
<span class="nc bnc" id="L277" title="All 2 branches missed.">            for (Document doc : documentos) {</span>
<span class="nc" id="L278">                habitaciones.add(Habitacion.fromDocument(doc));</span>
            }
<span class="nc" id="L280">            return habitaciones;</span>
<span class="nc" id="L281">        } catch (Exception e) {</span>
<span class="nc" id="L282">            System.err.println(&quot;Error al obtener todas las habitaciones: &quot; + e.getMessage());</span>
<span class="nc" id="L283">            return new ArrayList&lt;&gt;();</span>
        }
    }
    
    @Override
    public Habitacion buscarHabitacionPorNumero(String numero) {
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (numero == null || numero.trim().isEmpty()) {</span>
<span class="nc" id="L290">            return null;</span>
        }
        
        try {
<span class="nc" id="L294">            Document filtro = new Document(&quot;numero&quot;, numero);</span>
<span class="nc" id="L295">            List&lt;Document&gt; documentos = mongoCRUD.buscarPorFiltro(&quot;habitaciones&quot;, filtro);</span>
            
<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (!documentos.isEmpty()) {</span>
<span class="nc" id="L298">                return Habitacion.fromDocument(documentos.get(0));</span>
            }
<span class="nc" id="L300">        } catch (Exception e) {</span>
<span class="nc" id="L301">            System.err.println(&quot;Error al buscar habitación: &quot; + e.getMessage());</span>
        }
<span class="nc" id="L303">        return null;</span>
    }
    
    @Override
    public boolean actualizarEstadoHabitacion(String idHabitacion, boolean ocupada) {
        try {
<span class="nc" id="L309">            Document actualizacion = new Document(&quot;$set&quot;, new Document(&quot;ocupada&quot;, ocupada));</span>
<span class="nc" id="L310">            return mongoCRUD.actualizarPorId(&quot;habitaciones&quot;, idHabitacion, actualizacion);</span>
<span class="nc" id="L311">        } catch (Exception e) {</span>
<span class="nc" id="L312">            System.err.println(&quot;Error al actualizar habitación: &quot; + e.getMessage());</span>
<span class="nc" id="L313">            return false;</span>
        }
    }
    
    @Override
    public void inicializarHabitaciones() {
        try {
<span class="nc" id="L320">            List&lt;Habitacion&gt; habitaciones = obtenerTodasHabitaciones();</span>
            
            // Si hay menos de 20 habitaciones, reinicializar todas
<span class="nc bnc" id="L323" title="All 2 branches missed.">            if (habitaciones.size() &lt; 20) {</span>
                // Limpiar habitaciones existentes
<span class="nc" id="L325">                List&lt;Document&gt; docs = mongoCRUD.listarTodos(&quot;habitaciones&quot;);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                for (Document doc : docs) {</span>
<span class="nc" id="L327">                    mongoCRUD.eliminarPorId(&quot;habitaciones&quot;, doc.getString(&quot;_id&quot;));</span>
                }
                
                // Crear las 20 habitaciones como en el código original
<span class="nc bnc" id="L331" title="All 2 branches missed.">                for (int i = 1; i &lt;= 20; i++) {</span>
<span class="nc" id="L332">                    String numero = String.format(&quot;%03d&quot;, i); // 001, 002, 003...</span>
<span class="nc" id="L333">                    String id = &quot;HAB-&quot; + numero; // ID legible</span>
<span class="nc bnc" id="L334" title="All 4 branches missed.">                    String tipo = (i &lt;= 5) ? &quot;Suite&quot; : (i &lt;= 12) ? &quot;Doble&quot; : &quot;Simple&quot;;</span>
<span class="nc bnc" id="L335" title="All 4 branches missed.">                    double precio = (i &lt;= 5) ? 120.0 : (i &lt;= 12) ? 80.0 : 50.0;</span>
                    
<span class="nc" id="L337">                    Habitacion hab = new Habitacion(id, numero, tipo, false, precio);</span>
<span class="nc" id="L338">                    mongoCRUD.insertar(&quot;habitaciones&quot;, hab.toDocument());</span>
                }
                
                // Inicializar gestor de disponibilidad
<span class="nc" id="L342">                gestorDisponibilidad.inicializar(obtenerTodasHabitaciones());</span>
            }
<span class="nc" id="L344">        } catch (Exception e) {</span>
<span class="nc" id="L345">            System.err.println(&quot;Error al inicializar habitaciones: &quot; + e.getMessage());</span>
        }
<span class="nc" id="L347">    }</span>
    
    // === OPERACIONES DE RESERVAS ===
    
    @Override
    public boolean crearReserva(Reserva reserva) {
<span class="nc bnc" id="L353" title="All 6 branches missed.">        if (reserva == null || reserva.getIdCliente() == null || reserva.getIdHabitacion() == null) {</span>
<span class="nc" id="L354">            return false;</span>
        }
        
        // Verificar que el cliente existe (buscar por ID, no por cédula)
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (buscarClientePorId(reserva.getIdCliente()) == null) {</span>
<span class="nc" id="L359">            return false;</span>
        }
        
        // Verificar que la habitación existe y está disponible (buscar por ID)
<span class="nc" id="L363">        List&lt;Habitacion&gt; todasHabitaciones = obtenerTodasHabitaciones();</span>
<span class="nc" id="L364">        Habitacion habitacion = todasHabitaciones.stream()</span>
<span class="nc" id="L365">            .filter(h -&gt; h.getId().equals(reserva.getIdHabitacion()))</span>
<span class="nc" id="L366">            .findFirst()</span>
<span class="nc" id="L367">            .orElse(null);</span>
            
<span class="nc bnc" id="L369" title="All 4 branches missed.">        if (habitacion == null || habitacion.isOcupada()) {</span>
<span class="nc" id="L370">            return false;</span>
        }
        
        try {
            // Generar ID si no existe
<span class="nc bnc" id="L375" title="All 4 branches missed.">            if (reserva.getId() == null || reserva.getId().trim().isEmpty()) {</span>
<span class="nc" id="L376">                reserva.setId(generarCodigoReserva());</span>
            }
            
            // Crear la reserva
<span class="nc" id="L380">            mongoCRUD.insertar(&quot;reservas&quot;, reserva.toDocument());</span>
            
            // Marcar habitación como ocupada
<span class="nc" id="L383">            actualizarEstadoHabitacion(habitacion.getId(), true);</span>
            
            // Actualizar gestor de disponibilidad
<span class="nc" id="L386">            gestorDisponibilidad.reservarHabitacion(habitacion.getId());</span>
            
<span class="nc" id="L388">            return true;</span>
<span class="nc" id="L389">        } catch (Exception e) {</span>
<span class="nc" id="L390">            System.err.println(&quot;Error al crear reserva: &quot; + e.getMessage());</span>
<span class="nc" id="L391">            return false;</span>
        }
    }
    
    @Override
    public Reserva buscarReservaActivaPorCedula(String cedula) {
<span class="nc bnc" id="L397" title="All 4 branches missed.">        if (cedula == null || cedula.trim().isEmpty()) {</span>
<span class="nc" id="L398">            return null;</span>
        }
        
        try {
            // Primero buscar el cliente por cédula para obtener su ID
<span class="nc" id="L403">            Cliente cliente = buscarClientePorCedula(cedula);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (cliente == null) {</span>
<span class="nc" id="L405">                return null;</span>
            }
            
            // Luego buscar la reserva activa por ID del cliente
<span class="nc" id="L409">            Document filtro = new Document(&quot;idCliente&quot;, cliente.getId()).append(&quot;fechaSalida&quot;, null);</span>
<span class="nc" id="L410">            List&lt;Document&gt; documentos = mongoCRUD.buscarPorFiltro(&quot;reservas&quot;, filtro);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">            if (!documentos.isEmpty()) {</span>
<span class="nc" id="L412">                return Reserva.fromDocument(documentos.get(0));</span>
            }
<span class="nc" id="L414">        } catch (Exception e) {</span>
<span class="nc" id="L415">            System.err.println(&quot;Error al buscar reserva activa: &quot; + e.getMessage());</span>
        }
<span class="nc" id="L417">        return null;</span>
    }
    
    @Override
    public boolean finalizarReserva(String idReserva) {
        try {
<span class="nc" id="L423">            Document actualizacion = new Document(&quot;$set&quot;, new Document(&quot;fechaSalida&quot;, new Date()));</span>
<span class="nc" id="L424">            boolean actualizada = mongoCRUD.actualizarPorId(&quot;reservas&quot;, idReserva, actualizacion);</span>
            
<span class="nc bnc" id="L426" title="All 2 branches missed.">            if (actualizada) {</span>
                // Buscar la reserva para obtener el ID de habitación
<span class="nc" id="L428">                Document reservaDoc = mongoCRUD.buscarPorId(&quot;reservas&quot;, idReserva);</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                if (reservaDoc != null) {</span>
<span class="nc" id="L430">                    Reserva reserva = Reserva.fromDocument(reservaDoc);</span>
                    // Buscar habitación por ID, no por número
<span class="nc" id="L432">                    List&lt;Habitacion&gt; todasHabitaciones = obtenerTodasHabitaciones();</span>
<span class="nc" id="L433">                    Habitacion habitacion = todasHabitaciones.stream()</span>
<span class="nc" id="L434">                        .filter(h -&gt; h.getId().equals(reserva.getIdHabitacion()))</span>
<span class="nc" id="L435">                        .findFirst()</span>
<span class="nc" id="L436">                        .orElse(null);</span>
                    
<span class="nc bnc" id="L438" title="All 2 branches missed.">                    if (habitacion != null) {</span>
                        // Liberar habitación
<span class="nc" id="L440">                        actualizarEstadoHabitacion(habitacion.getId(), false);</span>
<span class="nc" id="L441">                        gestorDisponibilidad.liberarHabitacion(habitacion.getId());</span>
                    }
                }
            }
<span class="nc" id="L445">            return actualizada;</span>
<span class="nc" id="L446">        } catch (Exception e) {</span>
<span class="nc" id="L447">            System.err.println(&quot;Error al finalizar reserva: &quot; + e.getMessage());</span>
<span class="nc" id="L448">            return false;</span>
        }
    }
    
    @Override
    public List&lt;Reserva&gt; obtenerTodasReservas() {
        try {
<span class="nc" id="L455">            List&lt;Document&gt; documentos = mongoCRUD.listarTodos(&quot;reservas&quot;);</span>
<span class="nc" id="L456">            List&lt;Reserva&gt; reservas = new ArrayList&lt;&gt;();</span>
            
<span class="nc bnc" id="L458" title="All 2 branches missed.">            for (Document doc : documentos) {</span>
<span class="nc" id="L459">                reservas.add(Reserva.fromDocument(doc));</span>
            }
<span class="nc" id="L461">            return reservas;</span>
<span class="nc" id="L462">        } catch (Exception e) {</span>
<span class="nc" id="L463">            System.err.println(&quot;Error al obtener reservas: &quot; + e.getMessage());</span>
<span class="nc" id="L464">            return new ArrayList&lt;&gt;();</span>
        }
    }
    
    @Override
    public List&lt;Reserva&gt; obtenerReservasRecientes(int limite) {
        try {
<span class="nc" id="L471">            List&lt;Document&gt; documentos = mongoCRUD.listarTodos(&quot;reservas&quot;);</span>
<span class="nc" id="L472">            List&lt;Reserva&gt; reservas = new ArrayList&lt;&gt;();</span>
            
<span class="nc bnc" id="L474" title="All 2 branches missed.">            for (Document doc : documentos) {</span>
<span class="nc" id="L475">                reservas.add(Reserva.fromDocument(doc));</span>
            }
            
            // Ordenar por fecha de ingreso (más recientes primero)
<span class="nc" id="L479">            reservas.sort((r1, r2) -&gt; r2.getFechaIngreso().compareTo(r1.getFechaIngreso()));</span>
            
            // Limitar el resultado
<span class="nc" id="L482">            return reservas.stream()</span>
<span class="nc" id="L483">                .limit(limite)</span>
<span class="nc" id="L484">                .collect(java.util.stream.Collectors.toList());</span>
                
<span class="nc" id="L486">        } catch (Exception e) {</span>
<span class="nc" id="L487">            System.err.println(&quot;Error al obtener reservas recientes: &quot; + e.getMessage());</span>
<span class="nc" id="L488">            return new ArrayList&lt;&gt;();</span>
        }
    }
    
    // === OPERACIONES DE MEMENTO ===
    
    @Override
    public ModeloMemento crearMemento() {
<span class="nc" id="L496">        List&lt;Cliente&gt; clientes = obtenerTodosClientes();</span>
<span class="nc" id="L497">        List&lt;Habitacion&gt; habitaciones = obtenerTodasHabitaciones();</span>
<span class="nc" id="L498">        List&lt;Reserva&gt; reservas = obtenerTodasReservas();</span>
        
<span class="nc" id="L500">        return new ModeloMemento(clientes, habitaciones, reservas);</span>
    }
    
    @Override
    public void restaurarEstadoCompleto(ModeloMemento memento) {
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (memento == null) {</span>
<span class="nc" id="L506">            return;</span>
        }
        
        try {
            // Limpiar colecciones existentes
<span class="nc" id="L511">            mongoCRUD.eliminarTodos(&quot;clientes&quot;);</span>
<span class="nc" id="L512">            mongoCRUD.eliminarTodos(&quot;habitaciones&quot;);</span>
<span class="nc" id="L513">            mongoCRUD.eliminarTodos(&quot;reservas&quot;);</span>
            
            // Restaurar datos del memento
<span class="nc bnc" id="L516" title="All 2 branches missed.">            for (Cliente cliente : memento.getClientes()) {</span>
<span class="nc" id="L517">                mongoCRUD.insertar(&quot;clientes&quot;, cliente.toDocument());</span>
            }
            
<span class="nc bnc" id="L520" title="All 2 branches missed.">            for (Habitacion habitacion : memento.getHabitaciones()) {</span>
<span class="nc" id="L521">                mongoCRUD.insertar(&quot;habitaciones&quot;, habitacion.toDocument());</span>
            }
            
<span class="nc bnc" id="L524" title="All 2 branches missed.">            for (Reserva reserva : memento.getReservas()) {</span>
<span class="nc" id="L525">                mongoCRUD.insertar(&quot;reservas&quot;, reserva.toDocument());</span>
            }
            
            // Actualizar gestor de disponibilidad
<span class="nc" id="L529">            gestorDisponibilidad.inicializar(memento.getHabitaciones());</span>
            
<span class="nc" id="L531">        } catch (Exception e) {</span>
<span class="nc" id="L532">            System.err.println(&quot;Error al restaurar estado: &quot; + e.getMessage());</span>
        }
<span class="nc" id="L534">    }</span>
    
    @Override
    public boolean verificarDisponibilidad() {
        try {
            // Verificar conectividad de base de datos
<span class="nc" id="L540">            List&lt;Document&gt; test = mongoCRUD.listarTodos(&quot;habitaciones&quot;);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            return test != null;</span>
<span class="nc" id="L542">        } catch (Exception e) {</span>
<span class="nc" id="L543">            System.err.println(&quot;Error en verificación de disponibilidad: &quot; + e.getMessage());</span>
<span class="nc" id="L544">            return false;</span>
        }
    }
    
    /**
     * Método de debug para verificar el estado de las habitaciones.
     */
    public void debugEstadoHabitaciones() {
<span class="nc" id="L552">        System.out.println(&quot;=== DEBUG ESTADO HABITACIONES ===&quot;);</span>
        try {
<span class="nc" id="L554">            List&lt;Habitacion&gt; todasHabitaciones = obtenerTodasHabitaciones();</span>
<span class="nc" id="L555">            System.out.println(&quot;Total habitaciones: &quot; + todasHabitaciones.size());</span>
            
<span class="nc" id="L557">            int disponibles = 0, ocupadas = 0;</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">            for (Habitacion h : todasHabitaciones) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                if (h.isOcupada()) {</span>
<span class="nc" id="L560">                    ocupadas++;</span>
<span class="nc" id="L561">                    System.out.println(&quot;OCUPADA: &quot; + h.getNumero() + &quot; - &quot; + h.getTipo() + &quot; (ID: &quot; + h.getId() + &quot;)&quot;);</span>
<span class="nc" id="L562">                } else {</span>
<span class="nc" id="L563">                    disponibles++;</span>
                }
            }
            
<span class="nc" id="L567">            System.out.println(&quot;Disponibles: &quot; + disponibles + &quot;, Ocupadas: &quot; + ocupadas);</span>
            
            // Verificar reservas
<span class="nc" id="L570">            List&lt;Reserva&gt; reservas = obtenerTodasReservas();</span>
<span class="nc" id="L571">            System.out.println(&quot;Total reservas: &quot; + reservas.size());</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">            for (Reserva r : reservas) {</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                if (r.getFechaSalida() == null) {</span>
<span class="nc" id="L574">                    System.out.println(&quot;RESERVA ACTIVA: Cliente &quot; + r.getIdCliente() + &quot; -&gt; Habitación &quot; + r.getIdHabitacion());</span>
                }
            }
            
<span class="nc" id="L578">        } catch (Exception e) {</span>
<span class="nc" id="L579">            System.err.println(&quot;Error en debug: &quot; + e.getMessage());</span>
        }
<span class="nc" id="L581">        System.out.println(&quot;=== FIN DEBUG ===&quot;);</span>
<span class="nc" id="L582">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>