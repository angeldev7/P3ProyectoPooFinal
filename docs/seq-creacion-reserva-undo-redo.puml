@startuml
title Flujo Crear Reserva con Undo y Redo (MVC + Command + Memento)

actor Admin
participant VentanaAdmin
participant ControladorVentanaAdmin as Controller
participant CommandInvoker as Invoker
participant CrearReservaCommand as Cmd
participant IModeloService as Servicio
participant ModeloMemento as Memento
database MongoDB

== Crear Reserva ==
Admin -> VentanaAdmin : Clic "Crear Reserva"
VentanaAdmin -> Controller : solicitarCrearReserva(datos)
Controller -> Invoker : executeCommand( new CrearReservaCommand )
activate Invoker
Invoker -> Servicio : crearMemento()
activate Servicio
Servicio -> MongoDB : leer clientes/habitaciones/reservas
MongoDB --> Servicio : snapshot datos
Servicio --> Invoker : Memento
deactivate Servicio

Invoker -> Cmd : execute()
activate Cmd
Cmd -> Servicio : crearReserva(reserva)
Servicio -> MongoDB : insertar reserva
Servicio -> MongoDB : actualizar habitacion(ocupada=true)
MongoDB --> Servicio : ok
Servicio --> Cmd : true
deactivate Cmd

Invoker -> Invoker : push(command)
Invoker -> Invoker : push(memento)
Invoker --> Controller : resultado OK
Deactivate Invoker
Controller --> VentanaAdmin : refrescar tabla
VentanaAdmin --> Admin : reserva visible

== Undo ==
Admin -> VentanaAdmin : Clic Undo
VentanaAdmin -> Controller : undo()
Controller -> Invoker : undo()
activate Invoker
Invoker -> Invoker : pop memento + command
Invoker -> Servicio : restaurarEstadoCompleto(memento)
activate Servicio
Servicio -> MongoDB : limpiar colecciones
Servicio -> MongoDB : insertar snapshot
MongoDB --> Servicio : ok
Servicio --> Invoker : restaurado
deactivate Servicio
Invoker --> Controller : undo OK
Deactivate Invoker
Controller --> VentanaAdmin : refrescar UI
VentanaAdmin --> Admin : estado previo

== Redo ==
Admin -> VentanaAdmin : Clic Redo
VentanaAdmin -> Controller : redo()
Controller -> Invoker : redo()
activate Invoker
Invoker -> Cmd : execute() (reaplica)
activate Cmd
Cmd -> Servicio : crearReserva(reserva)
Servicio -> MongoDB : insertar / marcar habitacion ocupada
MongoDB --> Servicio : ok
Servicio --> Cmd : true
Deactivate Cmd
Invoker -> Servicio : crearMemento() (nuevo snapshot)
activate Servicio
Servicio -> MongoDB : leer estado actual
MongoDB --> Servicio : datos
Servicio --> Invoker : nuevo Memento
deactivate Servicio
Invoker -> Invoker : push(command+memento)
Invoker --> Controller : redo OK
Deactivate Invoker
Controller --> VentanaAdmin : refrescar UI
VentanaAdmin --> Admin : estado final

@enduml
