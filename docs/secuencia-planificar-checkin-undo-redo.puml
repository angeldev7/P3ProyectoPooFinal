@startuml
title Secuencia: Planificar Reserva vs Check-in Rápido (Undo/Redo)
actor Usuario as Admin
participant VentanaAdmin as UI
participant ControladorVentanaAdmin as Ctrl
participant CommandInvoker as Invoker
participant CrearReservaCommand as CrearCmd
participant CheckinRapidoAdminCommand as CheckinCmd
participant IModeloService as Servicio
participant ModeloMemento as Memento
database MongoDB

== Planificar Reserva (NO ocupa habitación) ==
Admin -> UI : Clic "Nueva Reserva"
UI -> Ctrl : solicitarCrearReserva(datos)
Ctrl -> Invoker : executeCommand(new CrearReservaCommand)
activate Invoker
Invoker -> Servicio : crearMemento()
Servicio -> MongoDB : leer estado
MongoDB --> Servicio : snapshot
Servicio --> Invoker : Memento
Invoker -> CrearCmd : execute()
activate CrearCmd
CrearCmd -> Servicio : crearReserva(planificada)
Servicio -> MongoDB : insertar reserva(planificada)
MongoDB --> Servicio : OK
Servicio --> CrearCmd : true
deactivate CrearCmd
Invoker -> Invoker : push(command+memento)
Invoker --> Ctrl : ok
deactivate Invoker
Ctrl --> UI : refrescar (estado = Reservada)

== Check-in Rápido (OCUPA de inmediato) ==
Admin -> UI : Clic "Check-in Rápido"
UI -> Ctrl : checkinRapido(hab)
Ctrl -> Invoker : executeCommand(new CheckinRapidoAdminCommand)
activate Invoker
Invoker -> Servicio : crearMemento()
Servicio -> MongoDB : leer estado
MongoDB --> Servicio : snapshot
Servicio --> Invoker : Memento
Invoker -> CheckinCmd : execute()
activate CheckinCmd
CheckinCmd -> Servicio : crearReserva(activa)
Servicio -> MongoDB : insertar reserva(fechaIngreso != null)
Servicio -> MongoDB : actualizar habitacion(ocupada=true)
MongoDB --> Servicio : OK
Servicio --> CheckinCmd : true
deactivate CheckinCmd
Invoker -> Invoker : push(command+memento)
Invoker --> Ctrl : ok
deactivate Invoker
Ctrl --> UI : refrescar (estado = Check-in)

== Undo sobre cualquier comando ==
Admin -> UI : Clic Undo
UI -> Ctrl : undo()
Ctrl -> Invoker : undo()
activate Invoker
Invoker -> Invoker : pop memento + command
Invoker -> Servicio : restaurarEstadoCompleto(memento)
Servicio -> MongoDB : reescribir colecciones
MongoDB --> Servicio : OK
Servicio --> Invoker : restaurado
Invoker --> Ctrl : undo OK
deactivate Invoker
Ctrl --> UI : refrescar listado

== Redo ==
Admin -> UI : Clic Redo
UI -> Ctrl : redo()
Ctrl -> Invoker : redo()
activate Invoker
Invoker -> (command) : execute()
... igual a flujo crear o check-in ...
Invoker -> Servicio : crearMemento()
Servicio -> MongoDB : leer estado
MongoDB --> Servicio : datos
Servicio --> Invoker : nuevo Memento
Invoker -> Invoker : push(command+memento)
Invoker --> Ctrl : redo OK
deactivate Invoker
Ctrl --> UI : refrescar

note bottom of CrearCmd
No marca habitación ocupada
fechaIngreso permanece null
end note

note bottom of CheckinCmd
fechaIngreso se asigna
habitacion.ocupada = true
end note
@enduml
